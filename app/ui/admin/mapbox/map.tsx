'use client'
import { sjsu_location } from "@/app/lib/utils";
import { FeatureCollection } from "geojson";
import "mapbox-gl/dist/mapbox-gl.css";
import Image from 'next/image';
import { useEffect, useState } from "react";
import Map, { GeolocateControl, Layer, LineLayer, Marker, NavigationControl, Source } from "react-map-gl";

/*
  Author: Hung Pham
  Email: mryo.hp@gmail.com | hung.pham@sjsu.edu
  Copyright (c) 2023 Hung Pham. All rights reserved.
*/

type Position = [number, number];
export default function MapBox() {
    const mapboxToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
    const [geojson, setGeojson] = useState<FeatureCollection>();
    // Color:teal
    const layerStyle: LineLayer = {
        id: 'LineString',
        type: 'line',
        paint: {
            'line-color': '#0096FF',
            'line-width': 8,
            'line-opacity': 0.8
        }
    };

    // sjsu_location
    const [markerPosition, setMarkerPosition] = useState<Position>([sjsu_location.longitude, sjsu_location.latitute]);


    const [customer1_done, setCustomer1_done] = useState(false);
    const [customer2_done, setCustomer2_done] = useState(false);
    const [index, setIndex] = useState(0);

    const [speed, setSpeed] = useState(50);
    const [timer_speed, setTimer_speed] = useState(1000);
    useEffect(() => {
        const customer1_location: Position = [-121.982959, 37.39276];
        const customer2_location: Position = [-122.063815, 37.412662];
        const lineStringCoords: [number, number][] = [
            [-121.883105, 37.336248],
            [-121.883148, 37.336311],
            [-121.882483, 37.336636],
            [-121.882371, 37.336691],
            [-121.882681, 37.337124],
            [-121.882762, 37.337242],
            [-121.882787, 37.337287],
            [-121.882819, 37.337342],
            [-121.882872, 37.337418],
            [-121.88289, 37.337442],
            [-121.883639, 37.338455],
            [-121.883821, 37.338693],
            [-121.88387, 37.338761],
            [-121.883884, 37.338781],
            [-121.884142, 37.339113],
            [-121.884202, 37.339199],
            [-121.884117, 37.339241],
            [-121.884005, 37.339296],
            [-121.883789, 37.339398],
            [-121.883752, 37.339416],
            [-121.883482, 37.339544],
            [-121.883437, 37.339565],
            [-121.883153, 37.339701],
            [-121.882842, 37.339848],
            [-121.882819, 37.339858],
            [-121.882664, 37.339933],
            [-121.882526, 37.339999],
            [-121.882484, 37.340019],
            [-121.88246, 37.34003],
            [-121.88219, 37.340158],
            [-121.882102, 37.3402],
            [-121.882009, 37.340244],
            [-121.881671, 37.340405],
            [-121.881474, 37.340499],
            [-121.88113, 37.34066],
            [-121.881102, 37.340673],
            [-121.881039, 37.340703],
            [-121.880974, 37.340736],
            [-121.880653, 37.340887],
            [-121.880577, 37.340923],
            [-121.88044, 37.340988],
            [-121.880345, 37.341033],
            [-121.880301, 37.341054],
            [-121.88009, 37.341155],
            [-121.880016, 37.341187],
            [-121.879914, 37.341237],
            [-121.879502, 37.341432],
            [-121.879409, 37.341475],
            [-121.879385, 37.341487],
            [-121.879247, 37.341552],
            [-121.879046, 37.341647],
            [-121.878757, 37.341786],
            [-121.878719, 37.341805],
            [-121.878465, 37.341924],
            [-121.878337, 37.341984],
            [-121.878201, 37.342049],
            [-121.87811, 37.342092],
            [-121.878033, 37.342129],
            [-121.87787, 37.342208],
            [-121.877842, 37.342221],
            [-121.877515, 37.342377],
            [-121.877406, 37.342429],
            [-121.877182, 37.342535],
            [-121.876724, 37.342757],
            [-121.87635, 37.342929],
            [-121.876245, 37.342978],
            [-121.876145, 37.343025],
            [-121.875967, 37.343112],
            [-121.875303, 37.343426],
            [-121.875019, 37.343561],
            [-121.874586, 37.343768],
            [-121.874471, 37.343823],
            [-121.874376, 37.34387],
            [-121.874291, 37.343911],
            [-121.874058, 37.344024],
            [-121.873617, 37.344231],
            [-121.873437, 37.344316],
            [-121.872536, 37.344743],
            [-121.872466, 37.344776],
            [-121.872119, 37.344941],
            [-121.871576, 37.345198],
            [-121.871427, 37.345269],
            [-121.871226, 37.345364],
            [-121.871035, 37.345455],
            [-121.870785, 37.345573],
            [-121.870709, 37.345609],
            [-121.870619, 37.345652],
            [-121.870543, 37.345688],
            [-121.870196, 37.345853],
            [-121.870054, 37.34592],
            [-121.869643, 37.346115],
            [-121.869532, 37.346167],
            [-121.869443, 37.34621],
            [-121.869329, 37.346263],
            [-121.868792, 37.346518],
            [-121.868687, 37.346568],
            [-121.868279, 37.346761],
            [-121.868142, 37.346826],
            [-121.867939, 37.346921],
            [-121.867825, 37.346975],
            [-121.867756, 37.347007],
            [-121.867683, 37.347039],
            [-121.867421, 37.347163],
            [-121.867325, 37.347209],
            [-121.867072, 37.34733],
            [-121.866844, 37.347438],
            [-121.866617, 37.347546],
            [-121.866474, 37.347614],
            [-121.866233, 37.347729],
            [-121.866121, 37.347781],
            [-121.865961, 37.347856],
            [-121.865887, 37.347891],
            [-121.865835, 37.347917],
            [-121.865586, 37.348038],
            [-121.865231, 37.348206],
            [-121.864965, 37.348331],
            [-121.864615, 37.348496],
            [-121.864568, 37.348518],
            [-121.864444, 37.348579],
            [-121.864364, 37.348618],
            [-121.864239, 37.348679],
            [-121.864154, 37.348721],
            [-121.864082, 37.348754],
            [-121.863789, 37.348889],
            [-121.863704, 37.348929],
            [-121.863623, 37.348966],
            [-121.863446, 37.349048],
            [-121.863142, 37.349199],
            [-121.862917, 37.34931],
            [-121.862826, 37.349308],
            [-121.862732, 37.34935],
            [-121.86271, 37.349359],
            [-121.862405, 37.349483],
            [-121.862248, 37.349547],
            [-121.86196, 37.349678],
            [-121.861358, 37.349962],
            [-121.861282, 37.349998],
            [-121.860836, 37.350216],
            [-121.860909, 37.350325],
            [-121.860989, 37.350444],
            [-121.861118, 37.350518],
            [-121.861855, 37.350894],
            [-121.862105, 37.351043],
            [-121.862305, 37.351191],
            [-121.862542, 37.351378],
            [-121.863078, 37.351854],
            [-121.863208, 37.351928],
            [-121.864211, 37.352825],
            [-121.864382, 37.352977],
            [-121.864487, 37.353071],
            [-121.864797, 37.353351],
            [-121.865036, 37.353564],
            [-121.865208, 37.353717],
            [-121.86609, 37.354429],
            [-121.86679, 37.354918],
            [-121.867469, 37.355521],
            [-121.868686, 37.356592],
            [-121.868794, 37.356679],
            [-121.868939, 37.356803],
            [-121.870384, 37.357928],
            [-121.871012, 37.358363],
            [-121.871573, 37.358728],
            [-121.872227, 37.359122],
            [-121.872796, 37.35944],
            [-121.873449, 37.359774],
            [-121.873963, 37.360022],
            [-121.874264, 37.360163],
            [-121.874634, 37.360321],
            [-121.875454, 37.360649],
            [-121.876159, 37.360889],
            [-121.876901, 37.36112],
            [-121.877462, 37.36129],
            [-121.878077, 37.361448],
            [-121.878665, 37.361577],
            [-121.879304, 37.36171],
            [-121.879788, 37.361802],
            [-121.880299, 37.36188],
            [-121.8813, 37.362008],
            [-121.888312, 37.362811],
            [-121.889377, 37.362921],
            [-121.891289, 37.363104],
            [-121.894811, 37.363412],
            [-121.898747, 37.363756],
            [-121.899477, 37.363823],
            [-121.900007, 37.363884],
            [-121.900518, 37.363966],
            [-121.901, 37.364056],
            [-121.901343, 37.36414],
            [-121.901763, 37.364263],
            [-121.902452, 37.364486],
            [-121.902808, 37.364615],
            [-121.903212, 37.364783],
            [-121.903587, 37.364952],
            [-121.904052, 37.3652],
            [-121.904365, 37.365385],
            [-121.904507, 37.365468],
            [-121.904688, 37.365585],
            [-121.90498, 37.365775],
            [-121.905272, 37.365984],
            [-121.905556, 37.366205],
            [-121.906079, 37.366613],
            [-121.907034, 37.367406],
            [-121.907446, 37.367739],
            [-121.907949, 37.368158],
            [-121.908523, 37.368607],
            [-121.909133, 37.369057],
            [-121.909541, 37.36932],
            [-121.909796, 37.369476],
            [-121.910055, 37.369623],
            [-121.910549, 37.369865],
            [-121.91121, 37.370138],
            [-121.912154, 37.370473],
            [-121.912864, 37.370702],
            [-121.913614, 37.370959],
            [-121.915241, 37.371458],
            [-121.915648, 37.371576],
            [-121.916073, 37.371685],
            [-121.916445, 37.371773],
            [-121.916872, 37.371858],
            [-121.917442, 37.37196],
            [-121.917583, 37.371986],
            [-121.918075, 37.372065],
            [-121.918996, 37.372212],
            [-121.919623, 37.37231],
            [-121.922205, 37.37267],
            [-121.922977, 37.372779],
            [-121.923509, 37.372861],
            [-121.924179, 37.372984],
            [-121.925181, 37.373222],
            [-121.926294, 37.373488],
            [-121.930052, 37.374379],
            [-121.932561, 37.374981],
            [-121.933146, 37.375125],
            [-121.935105, 37.375545],
            [-121.935294, 37.375589],
            [-121.937104, 37.375952],
            [-121.938757, 37.376283],
            [-121.941469, 37.376802],
            [-121.94258, 37.377018],
            [-121.945853, 37.377656],
            [-121.94758, 37.377991],
            [-121.947792, 37.378032],
            [-121.948073, 37.378087],
            [-121.948482, 37.378166],
            [-121.951255, 37.37872],
            [-121.95307, 37.379105],
            [-121.953914, 37.379298],
            [-121.955277, 37.379648],
            [-121.958657, 37.38062],
            [-121.958767, 37.380651],
            [-121.964132, 37.382176],
            [-121.968407, 37.383401],
            [-121.968939, 37.383556],
            [-121.972027, 37.38444],
            [-121.972251, 37.384506],
            [-121.972548, 37.384676],
            [-121.97287, 37.384795],
            [-121.973595, 37.385073],
            [-121.973749, 37.385137],
            [-121.973907, 37.385217],
            [-121.974133, 37.385348],
            [-121.974317, 37.38548],
            [-121.974501, 37.385622],
            [-121.974946, 37.386072],
            [-121.975394, 37.386516],
            [-121.975802, 37.386862],
            [-121.975879, 37.386948],
            [-121.975929, 37.38703],
            [-121.975955, 37.387093],
            [-121.975964, 37.387254],
            [-121.975916, 37.387512],
            [-121.975833, 37.387986],
            [-121.975812, 37.388169],
            [-121.975766, 37.388715],
            [-121.97576, 37.389361],
            [-121.975781, 37.389996],
            [-121.975829, 37.390341],
            [-121.975889, 37.390711],
            [-121.97599, 37.391045],
            [-121.976056, 37.39125],
            [-121.976089, 37.391364],
            [-121.976244, 37.391761],
            [-121.976381, 37.39211],
            [-121.976401, 37.392161],
            [-121.976558, 37.392491],
            [-121.976617, 37.392616],
            [-121.976833, 37.392547],
            [-121.976952, 37.392509],
            [-121.977149, 37.392447],
            [-121.97754, 37.392324],
            [-121.978185, 37.392117],
            [-121.978544, 37.392002],
            [-121.97876, 37.391984],
            [-121.978862, 37.391991],
            [-121.978923, 37.392011],
            [-121.978991, 37.392047],
            [-121.979039, 37.392086],
            [-121.979167, 37.392324],
            [-121.97918, 37.39242],
            [-121.979202, 37.392565],
            [-121.979212, 37.392685],
            [-121.979199, 37.392829],
            [-121.979143, 37.392974],
            [-121.978953, 37.393158],
            [-121.978805, 37.393336],
            [-121.978775, 37.393424],
            [-121.978746, 37.393514],
            [-121.978737, 37.393619],
            [-121.978762, 37.393798],
            [-121.978856, 37.393984],
            [-121.979004, 37.394116],
            [-121.979124, 37.394214],
            [-121.979306, 37.394283],
            [-121.979398, 37.394318],
            [-121.979444, 37.394331],
            [-121.979566, 37.394363],
            [-121.979741, 37.394411],
            [-121.97985, 37.394446],
            [-121.980094, 37.394524],
            [-121.980399, 37.394622],
            [-121.980527, 37.3947],
            [-121.980841, 37.394891],
            [-121.981197, 37.394998],
            [-121.981326, 37.395003],
            [-121.981905, 37.395067],
            [-121.98248, 37.395063],
            [-121.983087, 37.395063],
            [-121.983068, 37.394949],
            [-121.983055, 37.394902],
            [-121.982995, 37.394677],
            [-121.982953, 37.394522],
            [-121.982918, 37.394367],
            [-121.98288, 37.394204],
            [-121.982843, 37.394054],
            [-121.982804, 37.393894],
            [-121.98277, 37.393752],
            [-121.982727, 37.393587],
            [-121.982691, 37.393438],
            [-121.982658, 37.393308],
            [-121.982693, 37.393294],
            [-121.982783, 37.393233],
            [-121.982813, 37.393163],
            [-121.98282, 37.393097],
            [-121.982923, 37.393063],
            [-121.983237, 37.392961],
            [-121.983554, 37.392824],
            [-121.983466, 37.392718],
            [-121.983235, 37.392845],
            [-121.982999, 37.392712],
            [-121.982959, 37.39276],
            [-121.982816, 37.392933],
            [-121.982999, 37.392712],
            [-121.983235, 37.392845],
            [-121.983466, 37.392718],
            [-121.983554, 37.392824],
            [-121.983237, 37.392961],
            [-121.982923, 37.393063],
            [-121.98282, 37.393097],
            [-121.982617, 37.393138],
            [-121.982422, 37.393165],
            [-121.982242, 37.393179],
            [-121.981959, 37.393173],
            [-121.981737, 37.393149],
            [-121.981676, 37.393143],
            [-121.981632, 37.393273],
            [-121.981588, 37.393432],
            [-121.981546, 37.393588],
            [-121.981515, 37.393739],
            [-121.981472, 37.393899],
            [-121.981437, 37.394047],
            [-121.981395, 37.394202],
            [-121.981359, 37.394361],
            [-121.981322, 37.394525],
            [-121.981287, 37.394678],
            [-121.981256, 37.394813],
            [-121.981244, 37.394836],
            [-121.981215, 37.394895],
            [-121.980975, 37.394828],
            [-121.980424, 37.394523],
            [-121.979888, 37.394341],
            [-121.979601, 37.394262],
            [-121.979494, 37.394233],
            [-121.979467, 37.394225],
            [-121.979291, 37.394149],
            [-121.979128, 37.394081],
            [-121.978973, 37.393951],
            [-121.978879, 37.393761],
            [-121.978899, 37.393625],
            [-121.978925, 37.393411],
            [-121.979048, 37.393244],
            [-121.979225, 37.393087],
            [-121.979288, 37.392964],
            [-121.979336, 37.392847],
            [-121.979355, 37.392719],
            [-121.979354, 37.392564],
            [-121.97935, 37.392433],
            [-121.979331, 37.392301],
            [-121.979285, 37.392173],
            [-121.979148, 37.391898],
            [-121.979118, 37.391839],
            [-121.979055, 37.391716],
            [-121.978937, 37.391737],
            [-121.978846, 37.391754],
            [-121.97821, 37.391957],
            [-121.977976, 37.392028],
            [-121.977646, 37.392137],
            [-121.977302, 37.392247],
            [-121.977094, 37.392266],
            [-121.976941, 37.392266],
            [-121.9769, 37.392259],
            [-121.976804, 37.392212],
            [-121.97664, 37.392097],
            [-121.976482, 37.391728],
            [-121.976472, 37.391706],
            [-121.976324, 37.391302],
            [-121.976172, 37.390763],
            [-121.976088, 37.390319],
            [-121.976033, 37.389999],
            [-121.976007, 37.389112],
            [-121.976009, 37.388788],
            [-121.976021, 37.388354],
            [-121.9762, 37.387919],
            [-121.97639, 37.387556],
            [-121.976899, 37.386812],
            [-121.977084, 37.386643],
            [-121.97726, 37.386535],
            [-121.97743, 37.386479],
            [-121.977555, 37.386448],
            [-121.97779, 37.386434],
            [-121.978026, 37.386467],
            [-121.979284, 37.386743],
            [-121.980435, 37.386996],
            [-121.981288, 37.387188],
            [-121.982101, 37.3874],
            [-121.98229, 37.387377],
            [-121.98743, 37.388798],
            [-121.991193, 37.389886],
            [-121.992473, 37.390256],
            [-121.994031, 37.390703],
            [-121.996604, 37.39149],
            [-121.999337, 37.392304],
            [-122.002142, 37.393104],
            [-122.002719, 37.393268],
            [-122.006753, 37.394373],
            [-122.00929, 37.394906],
            [-122.009508, 37.394952],
            [-122.009897, 37.395034],
            [-122.014812, 37.39621],
            [-122.020633, 37.397479],
            [-122.020826, 37.397521],
            [-122.022492, 37.397884],
            [-122.024114, 37.398238],
            [-122.028239, 37.399157],
            [-122.03178, 37.399917],
            [-122.03517, 37.400663],
            [-122.037324, 37.401129],
            [-122.039132, 37.401538],
            [-122.04693, 37.403233],
            [-122.047022, 37.403253],
            [-122.048536, 37.403585],
            [-122.049493, 37.403794],
            [-122.050271, 37.403967],
            [-122.051016, 37.404137],
            [-122.051652, 37.404293],
            [-122.052352, 37.404476],
            [-122.054506, 37.405077],
            [-122.05516, 37.405254],
            [-122.055818, 37.405418],
            [-122.05652, 37.40558],
            [-122.062399, 37.406867],
            [-122.063473, 37.407194],
            [-122.064189, 37.407408],
            [-122.064283, 37.407441],
            [-122.064354, 37.407474],
            [-122.064418, 37.407514],
            [-122.064471, 37.407557],
            [-122.064514, 37.407601],
            [-122.064571, 37.40766],
            [-122.064805, 37.408048],
            [-122.064873, 37.408153],
            [-122.064954, 37.408282],
            [-122.06504, 37.408411],
            [-122.065089, 37.408485],
            [-122.065135, 37.408531],
            [-122.065184, 37.408579],
            [-122.065265, 37.408637],
            [-122.065333, 37.408679],
            [-122.065545, 37.408795],
            [-122.065647, 37.408842],
            [-122.065557, 37.40895],
            [-122.065356, 37.409112],
            [-122.065125, 37.409245],
            [-122.064925, 37.409335],
            [-122.064642, 37.409427],
            [-122.064138, 37.409586],
            [-122.063733, 37.409721],
            [-122.063615, 37.409761],
            [-122.063469, 37.409814],
            [-122.063532, 37.409937],
            [-122.063582, 37.410036],
            [-122.063599, 37.410068],
            [-122.063749, 37.410385],
            [-122.063881, 37.410714],
            [-122.063961, 37.411012],
            [-122.063987, 37.411361],
            [-122.063984, 37.411896],
            [-122.063985, 37.412422],
            [-122.063986, 37.41244],
            [-122.063918, 37.412442],
            [-122.063818, 37.412444],
            [-122.063813, 37.412444],
            [-122.063815, 37.412662]
        ];
        setGeojson({
            type: 'FeatureCollection',
            features: [
                {
                    type: 'Feature',
                    properties: {
                        title: 'Mapbox',
                        description: 'LineString Example'
                    },
                    geometry: {
                        type: 'LineString',
                        coordinates: lineStringCoords
                    },
                }
            ]
        });
        const moveMarker = () => {
            if (index <= lineStringCoords.length - 1) {
                if (!customer1_done) {
                    let dis1 = calculateDistance(customer1_location[0], customer1_location[1], lineStringCoords[index][0], lineStringCoords[index][1]);
                    if (dis1 < 10) {
                        setCustomer1_done(true);
                    }
                }
                if (!customer2_done) {
                    let dis2 = calculateDistance(customer2_location[0], customer2_location[1], lineStringCoords[index][0], lineStringCoords[index][1]);
                    if (dis2 < 10) {
                        setCustomer2_done(true);
                    }
                }
                setMarkerPosition(lineStringCoords[index]);
                setIndex(index + 1);
            }
        };
        const timerId = setInterval(moveMarker, timer_speed);
        return () => clearInterval(timerId);
    }, [index, customer1_done, customer2_done, timer_speed]);

    function calculateDistance(lon1: number, lat1: number, lon2: number, lat2: number): number {
        const earthRadius = 6371e3; // Radius of the Earth in meters
        const phi1 = (lat1 * Math.PI) / 180;
        const phi2 = (lat2 * Math.PI) / 180;
        const deltaPhi = ((lat2 - lat1) * Math.PI) / 180;
        const deltaLambda = ((lon2 - lon1) * Math.PI) / 180;

        const a =
            Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
            Math.cos(phi1) * Math.cos(phi2) * Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        const distance = earthRadius * c; // Distance in meters

        return distance;
    }

    function setRobotSpeed(speed: number) {
        setSpeed(speed);
        setTimer_speed(5000 / speed);
        console.log(timer_speed);
    }


    return (
        <>
            <div className="flex ">
                <h1 className='text-2xl w-64'>Delivery Status</h1>
                Speed:  <input type="range" min={1} max={4999} value={speed} onChange={(e) =>
                    setRobotSpeed(parseInt(e.target.value))
                } className="range range-primary w-96 ml-4" />
            </div>
            <main className="w-full h-screen">
                <Map
                    mapboxAccessToken={mapboxToken}
                    mapStyle="mapbox://styles/mapbox/streets-v12"
                    style={{ width: "100%", height: "80%" }}
                    initialViewState={{ latitude: sjsu_location.latitute, longitude: sjsu_location.longitude, zoom: 12 }}
                    maxZoom={20}
                    minZoom={3}
                >
                    <Source id="my-data" type="geojson" data={geojson}>
                        <Layer {...layerStyle} />
                    </Source>
                    <GeolocateControl />
                    <NavigationControl />
                    <Marker longitude={markerPosition[0]} latitude={markerPosition[1]} anchor="bottom">
                        <Image src="/images/logo.png" width={50} height={50} alt="robot" />
                    </Marker>
                    <Marker longitude={-121.9827822453428} latitude={37.392667807874886} anchor="bottom" >
                        <Image src="/images/avatar.svg" width={35} height={35} alt="customer" />
                    </Marker>
                    <Marker longitude={-122.06379663983735} latitude={37.41280313687151} anchor="bottom" >
                        <Image src="/images/avatar.svg" width={35} height={35} alt="customer" />
                    </Marker>
                </Map>
                <div className="w-full flex justify-center items-center">
                    <ul className="steps steps-vertical lg:steps-horizontal">
                        <li className="step step-primary mr-5">Start</li>
                        {customer1_done ? <li className="step step-primary mr-5">Customer1</li> : <li className="step mr-5">Customer1</li>}
                        {customer2_done ? <li className="step step-primary mr-5">Customer2</li> : <li className="step mr-5">Customer2</li>}
                    </ul>
                </div>
            </main>
        </>
    );
};